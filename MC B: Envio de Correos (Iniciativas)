/**
 * ==================================================
 * MICROSERVICIO DE LECTURA Y GENERACIÃ“N DE CORREOS
 * Solo lectura - Sin envÃ­o real
 * ==================================================
 */

// ğŸ”§ CONFIGURACIÃ“N
var CONFIG = {
  HOJA_INICIATIVAS: "Control Iniciativas",
  HOJA_OWNERS: "Sandbox Owners"
};

/**
 * ğŸ¯ FUNCIÃ“N PRINCIPAL - Leer y generar notificaciones
 */
function generarNotificaciones() {
  Logger.log("ğŸ“– Leyendo datos y generando notificaciones...");
  
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var hojaIniciativas = ss.getSheetByName(CONFIG.HOJA_INICIATIVAS);
    var hojaOwners = ss.getSheetByName(CONFIG.HOJA_OWNERS);

    if (!hojaIniciativas || !hojaOwners) {
      Logger.log("âŒ No se encontraron las hojas necesarias");
      return;
    }

    // 1. Construir mapa de owners
    var ownersMap = construirMapaOwners(hojaOwners);
    Logger.log("âœ… Mapa de owners construido: " + JSON.stringify(ownersMap));
    
    // 2. Obtener iniciativas pendientes
    var iniciativasPendientes = obtenerIniciativasPendientes(hojaIniciativas, ownersMap);
    Logger.log("ğŸ“‹ Total iniciativas a notificar: " + iniciativasPendientes.length);
    
    // 3. Generar notificaciones (solo logs)
    for (var i = 0; i < iniciativasPendientes.length; i++) {
      var iniciativa = iniciativasPendientes[i];
      generarNotificacionLog(iniciativa);
    }
    
    Logger.log("âœ… Proceso de lectura completado. Revisa los logs above â†‘");
    
  } catch (e) {
    Logger.log("âŒ Error: " + e.toString());
  }
}

/**
 * ğŸ‘¥ Construir mapa de owners
 */
function construirMapaOwners(hojaOwners) {
  var datos = hojaOwners.getDataRange().getValues();
  var ownersMap = {};
  
  for (var i = 1; i < datos.length; i++) {
    var sandbox = datos[i][0];
    var nombreOwner = datos[i][4];
    
    if (sandbox && nombreOwner) {
      var email = generarEmailOwner(nombreOwner);
      ownersMap[sandbox.toString().trim().toUpperCase()] = email;
    }
  }
  
  return ownersMap;
}

/**
 * ğŸ“§ Generar email from nombre
 */
function generarEmailOwner(nombreOwner) {
  var nombreLimpio = nombreOwner.toString().trim().toLowerCase()
    .replace(/\s+/g, '.')
    .split('@')[0];
  return nombreLimpio + "@empresa.com";
}

/**
 * ğŸ“‹ Obtener iniciativas pendientes de notificaciÃ³n
 */
function obtenerIniciativasPendientes(hojaIniciativas, ownersMap) {
  var datos = hojaIniciativas.getDataRange().getValues();
  var hoy = new Date();
  hoy.setHours(0, 0, 0, 0);
  var iniciativas = [];
  
  for (var j = 1; j < datos.length; j++) {
    var codigo = datos[j][0];
    var nombre = datos[j][1];
    var sandbox = datos[j][2];
    var estado = datos[j][3];
    var fechaVencimiento = datos[j][6];
    
    if (!codigo || !nombre || !sandbox) continue;
    
    // Convertir y validar fecha
    if (typeof fechaVencimiento === 'string') {
      fechaVencimiento = new Date(fechaVencimiento);
    }
    if (isNaN(fechaVencimiento)) continue;
    
    fechaVencimiento.setHours(0, 0, 0, 0);
    var diasRestantes = Math.floor((fechaVencimiento - hoy) / (1000 * 60 * 60 * 24));
    
    // Verificar si necesita notificaciÃ³n
    if (estado === "Vencida" || (diasRestantes <= 7 && diasRestantes >= 0)) {
      var emailOwner = ownersMap[sandbox.toString().trim().toUpperCase()];
      
      if (emailOwner) {
        iniciativas.push({
          codigo: codigo,
          nombre: nombre,
          sandbox: sandbox,
          estado: estado,
          email: emailOwner,
          diasRestantes: diasRestantes,
          fechaVencimiento: fechaVencimiento
        });
      }
    }
  }
  
  return iniciativas;
}

/**
 * ğŸ“ Generar notificaciÃ³n solo en logs
 */
function generarNotificacionLog(iniciativa) {
  var nombreOwner = iniciativa.email.split('@')[0].replace(/\./g, ' ');
  var fechaFormateada = Utilities.formatDate(iniciativa.fechaVencimiento, Session.getScriptTimeZone(), "dd/MM/yyyy");
  
  Logger.log("\n==========================================");
  Logger.log("ğŸ“§ NOTIFICACIÃ“N GENERADA (No enviada)");
  Logger.log("==========================================");
  Logger.log("â¡ï¸  Destinatario: " + iniciativa.email);
  Logger.log("ğŸ“¦ Sandbox: " + iniciativa.sandbox);
  Logger.log("ğŸ“‹ CÃ³digo: " + iniciativa.codigo);
  Logger.log("ğŸ·ï¸  Nombre: " + iniciativa.nombre);
  Logger.log("ğŸ“Š Estado: " + iniciativa.estado);
  Logger.log("â° DÃ­as restantes: " + iniciativa.diasRestantes);
  Logger.log("ğŸ“… Fecha vencimiento: " + fechaFormateada);
  Logger.log("==========================================");
  Logger.log("ğŸ’¬ Mensaje:");
  Logger.log("Estimado/a " + nombreOwner + ",");
  Logger.log("La iniciativa \"" + iniciativa.nombre + "\" (CÃ³digo: " + iniciativa.codigo + ")");
  Logger.log("asociada al Sandbox \"" + iniciativa.sandbox + "\" tiene el estado: " + iniciativa.estado + ".");
  Logger.log("DÃ­as restantes: " + iniciativa.diasRestantes);
  Logger.log("Fecha de Vencimiento: " + fechaFormateada);
  Logger.log("Por favor, proceda con la renovaciÃ³n en caso de ser necesario.");
  Logger.log("==========================================\n");
}

/**
 * ğŸ” FunciÃ³n para ver datos crudos
 */
function verDatosCrudos() {
  Logger.log("ğŸ‘€ Viendo datos crudos...");
  
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var hojaIniciativas = ss.getSheetByName(CONFIG.HOJA_INICIATIVAS);
    var hojaOwners = ss.getSheetByName(CONFIG.HOJA_OWNERS);

    if (!hojaIniciativas || !hojaOwners) {
      Logger.log("âŒ No se encontraron las hojas");
      return;
    }

    // Ver owners
    var datosOwners = hojaOwners.getDataRange().getValues();
    Logger.log("ğŸ‘¥ Owners (primeras 5 filas):");
    for (var i = 1; i < Math.min(6, datosOwners.length); i++) {
      Logger.log("Fila " + i + ": " + JSON.stringify(datosOwners[i]));
    }
    
    // Ver iniciativas
    var datosIniciativas = hojaIniciativas.getDataRange().getValues();
    Logger.log("\nğŸ“‹ Iniciativas (primeras 5 filas):");
    for (var j = 1; j < Math.min(6, datosIniciativas.length); j++) {
      Logger.log("Fila " + j + ": " + JSON.stringify(datosIniciativas[j]));
    }
    
  } catch (e) {
    Logger.log("âŒ Error: " + e.toString());
  }
}

/**
 * ğŸ§ª FunciÃ³n de prueba simple
 */
function pruebaSimple() {
  Logger.log("ğŸ§ª Probando lectura simple...");
  generarNotificaciones();
}

// ğŸ¯ EJECUTAR ESTAS FUNCIONES:
// generarNotificaciones() - Genera logs de todas las notificaciones
// verDatosCrudos() - Muestra los datos crudos de las hojas
// pruebaSimple() - Ejecuta el proceso completo